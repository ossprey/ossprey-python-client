#!/usr/bin/env bash
# To install run: cp .githooks/pre-push .git/hooks/pre-push

# Exit with code 1 if any command fails
set -euo pipefail
trap 'exit 1' ERR

# Run unit tests
poetry run pytest

# Run Smoke tests (fast, non-network subset)
# For the full smoke suite including network/slow tests, use:
#   poetry run pytest test/smoke/test_smoke.py
poetry run pytest test/smoke/test_smoke.py -m "smoke and not network and not slow"

# Test malicious detection (should fail with exit code 1)
if poetry run python -m ossprey --dry-run-malicious --package test/test_packages/npm_simple_math/ --mode npm; then
    echo "ERROR: Malicious package detection failed - should have detected malware!"
    exit 1
else
    echo "SUCCESS: Malicious package detection working correctly"
fi
