#!/usr/bin/env bash
# To install run: cp .githooks/pre-push .git/hooks/pre-push

# Exit with code 1 if any command fails
set -euo pipefail
trap 'exit 1' ERR

# Run unit tests
poetry run pytest

# Test with test packages locally
poetry run python -m ossprey --dry-run-safe --package test/test_packages/npm_simple_math/ --mode npm
poetry run python -m ossprey --dry-run-safe --package test/test_packages/yarn_simple_math/ --mode yarn
poetry run python -m ossprey --dry-run-safe --package test/test_packages/yarn_massive_math/ --mode yarn
poetry run python -m ossprey --dry-run-safe --package test/test_packages/python_simple_math/ --mode python-requirements
poetry run python -m ossprey --dry-run-safe --package test/test_packages/poetry_simple_math/ --mode poetry
poetry run python -m ossprey --dry-run-safe --package test/test_packages/poetry_broken_simple_math/


# Test malicious detection (should fail with exit code 1)
if poetry run python -m ossprey --dry-run-malicious --package test/test_packages/npm_simple_math/ --mode npm; then
    echo "ERROR: Malicious package detection failed - should have detected malware!"
    exit 1
else
    echo "SUCCESS: Malicious package detection working correctly"
fi
